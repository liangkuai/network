# 如何实现安全通信？

在学习 SSL/TLS 协议前，先思考一下，如果自己来设计 TLS 协议，应该如何实现一个安全通信协议？

### 1. 加密

**HTTP 协议最大的安全性缺点就是明文传输，所以加密是安全通信的基础。**

> 关于加密相关的知识可以参考：[加密](./加密.md)

#### 1.1 对称密钥加密

对称加密看上去好像完美地实现了加密，但其中有一个很大的问题：**如何把密钥安全地传递给对方？**，也就是所谓的「**密钥交换问题**」。

因为在对称加密算法中只要持有密钥就可以解密。**如果你和网站约定的密钥在传递途中被攻击者窃取，那他就可以在之后随意解密收发的数据，通信过程也就没有安全可言了。**

这个问题该怎么解决呢？你或许会说：“把密钥再加密一下发过去就好了”，但传输“加密密钥的密钥”又成了新问题。这就像是“鸡生蛋、蛋生鸡”，可以无限递归下去。只用对称加密算法，是绝对无法解决密钥交换的问题的。

> ***对称密钥加密解决了明文传输的问题，但是存在「密钥交换问题」。***

#### 1.2 非对称密钥加密

虽然非对称加密没有“密钥交换”的问题，但因为它们都是基于复杂的数学难题，**运算速度很慢**，即使是 ECC 也要比 AES 差上好几个数量级。如果仅用非对称加密，虽然保证了安全，但通信速度慢如蜗牛，实用性就变成了零。

#### 1.3 混合加密

如果把对称加密和非对称加密结合起来呢，两者互相取长补短，即能高效地加密解密，又能安全地密钥交换。在通信刚开始的时候先使用非对称加密，解决密钥交换问题；等对方拿到对称密钥之后，后续全部使用对称加密。


> 为什么客户端用公钥，服务端用私钥？
>
> 通常是由客户端发起通信请求，服务端对外提供服务；而非对称密钥加密中的公钥可以对外公布。所以一般是由服务端持有私钥用来解密，对外提供公钥用于加密。


#### 1.4 问题

采用混合加密之后，我们已经实现了安全通信协议的加密功能。但是我们可以看到，**通信双方在商量对称密钥进行加密通信前都是明文传输**，这样依然存在**篡改风险**和**伪装风险**。

##### 篡改风险

**攻击者介入客户端和服务端之间，篡改报文内容**，把服务端公钥改为自己的公钥，代替服务端与客户端通信；然后获取到客户端的对称密钥，改为自己的对称密钥发给服务端，代替客户端与服务端通信。后续的整个通信过程对攻击者来说都是透明的，所有数据都被获取。这就是**中间人攻击**。

##### 伪装风险

攻击者也可以直接伪装成服务端发布假公钥，客户端无法判断获取的公钥是否是真正的服务端公钥，这就是所谓的「**公钥信任问题**」。那么客户端整个过程都在与假的服务端通信，所有数据都会被获取。

> ***非对称密钥加密解决了密钥交换问题，但是存在「公钥信任问题」。***


