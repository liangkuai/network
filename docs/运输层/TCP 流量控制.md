# TCP 流量控制

虽然我们都希望数据传输的更快一点，但是如果发送方把数据发送的太快，接收方就可能来不及接收，这就会造成数据的丢失。

**流量控制**就是让「发送方」根据「接收方」的实际接收能力控制发送的数据量。

TCP 使用**滑动窗口机制**实现对发送方的流量控制。TCP 接收方利用自己的接收窗口（rwnd）的大小来限制发送方的发送窗口（swnd）大小


### 滑动窗口机制

#### 发送方的滑动窗口

发送方的缓冲区根据滑动窗口分为 4 个部分：

1. 已发送已确认
2. 已发送未确认
3. 待发送
4. 不可发送

发送窗口（swnd）=「已发送未确认」 + 「待发送」


#### 接收方的滑动窗口

接收方的缓冲区根据滑动窗口分为 3 个部分：

1. 已接收已确认
2. 待接收
3. 不可用

接收窗口（rwnd）=「待接收」


### 0 窗口问题与持续计时器 

假设当前接收方的 rwnd 调整为 0，并且给发送方发送了「零窗口报文段」（rwnd=0），发送方的发送窗口也调整为 0，此时发送方不能再发送报文段。

之后，接收方缓存有了一些存储空间，将 rwnd 调整为 1000，并且给发送发发送了 rwnd=1000 的报文段，但是这个报文段在传输过程中丢失了。这时，

- 发送方以为接收方的 rwnd 还是 0，就一直等待接收方的非零窗口通知
- 接收方以为发送方没有数据发送过来，就一直等待发送方发送数据

这就造成了死锁。

为了解决这个问题，TCP 为每一个连接设置一个持续计时器，只要 TCP 连接的一方收到对方的零窗口通知，就启动持续计时器。

如果持续计时器到期，就发送一个「零窗口探测报文段」（只有 1B 数据）。接收方收到探测报文段时给出现在的窗口值。

- 如果窗口仍然是 0，那么发送方就重置持续计时器。
- 如果不是 0，那么就可以解决死锁，正常传输。

> 接收方 rwnd=0 还能接收「零窗口探测报文段」？
>
> TCP 规定，即时 rwnd=0，也必须接收「零窗口探测报文段」、ACK 报文段、以及携带有紧急数据的报文段。


### 参考

- [5.3.4 流量控制 - 计算机网络 - 王道论坛 - bilibili](https://www.bilibili.com/video/BV19E411D78Q?p=66)
- [5.4 TCP的流量控制 - 计算机网络微课堂 - 湖科大教书匠 - bilibili](https://www.bilibili.com/video/BV1c4411d7jb?p=60)
- [30张图解： TCP 重传、滑动窗口、流量控制、拥塞控制发愁 - 小林coding的文章 - 知乎](https://zhuanlan.zhihu.com/p/133307545)