# TCP 拥塞控制


### 与流量控制的区别

拥塞控制是一个全局性的机制，防止网络中所有主机发送的数据过多，超出了网络的承载能力。如果出现拥塞而不进行控制，整个网络的吞吐量将随负荷的增大而下降。

而流量控制只是一个端到端的机制，目的是限制发送方发送的数据量，让接收方来得及处理。


### 拥塞窗口（cwnd）

为了进行拥塞控制，发送方维护一个叫做「拥塞窗口」（cwnd）的变量。拥塞控制窗口的大小取决于网络的拥塞程度，并且动态变化。

- 拥塞窗口的维护原则：只要网络没有出现拥塞，拥塞窗口就增大一些；但只要网络出现拥塞，拥塞窗口就减小一些

> ***判断网络拥塞的依据：发送超时重传，也就是发送方没有按时收到确认报文段***

#### 拥塞窗口与发送窗口

> ***发送窗口（swnd） = Min {接收窗口（rwnd），拥塞窗口（cwnd）}***

- 接收窗口：**接收方**根据缓存容量设置的值，并且告诉发送方，用来反映接收方的接收容量

- 拥塞窗口：**发送方**根据自己估算的网络拥塞程度而设置的窗口值，用来反映网络当前容量


### TCP 拥塞控制算法

TCP 的拥塞控制采用了 4 个算法：

- 慢开始
- 拥塞避免
- 快重传
- 快恢复

#### 慢开始（slow-start）

**当连接刚建立，cwnd = 1 MSS。**

当发送方每收到一个 ACK，拥塞窗口（cwnd）的大小就会加 1 MMS。或者说，每经过一个传输轮次，`cwnd * 2`（指数级增长）。


在慢开始算法中，当 cwnd 增长到 `ssthresh` （慢开始门限值）时，就使用「拥塞避免」算法。

- 当 cwnd < ssthresh 时，使用「慢开始」算法。
- 当 cwnd >= ssthresh 时，使用「拥塞避免」算法。

> “慢开始”指的是一开始网络中注入的报文段少，而不是拥塞窗口 cwnd 增长速度慢。

#### 拥塞避免（congestion avoidance）

每当收到一个 ACK 时，cwnd 增加 1/cwnd。或者说，每经过一个传输轮次，`cwnd + 1`（线性增长）。


> “拥塞避免”不是指完全能够避免拥塞，而是指在拥塞避免阶段将拥塞窗口控制为按线性规律增长，使网络更不容易拥塞。

> 当网络发生拥塞时，也就是发生 ***超时重传***，
> 
> - `ssthresh = cwnd/2`
> - `cwnd = 1`
> - 重新开始执行「慢开始」算法
>
> 这是是 1988 年提出的 TCP 拥塞控制算法（TCP Tahoe 版本）
>
> 有时个别报文段会丢失，但实际上网络并未发生拥塞。这也会导致超时重传，并且误认为网络拥塞。如果执行上述操作会降低传输效率。
>
> 所以 1990 年增加了快重传和快恢复算法来改进 TCP 性能（TCP Reno 版本）

#### 快重传（fast retransmit）

传发送方一旦收到 3 个连续的重复确认，就将相应的报文段立即重传，而不是等到超时再重传。

#### 快恢复（fast recovery）

发送方一旦收到 3 个重复确认，就说明网络不是那么糟糕，只是丢失了个别报文段。 于是执行快恢复算法：

1. 慢开始门限值和拥塞窗口都设置有原拥塞窗口的一般

    - `ssthresh = cwnd/2`
    - `cwnd = ssthresh`

> 有的快恢复算法实现，把快恢复开始时的拥塞窗口设置为 ssthresh + 3

2. 开始执行「拥塞避免」算法


### 参考

- [5.3.5 拥塞控制 - 计算机网络 - 王道论坛 - bilibili](https://www.bilibili.com/video/BV19E411D78Q?p=67)
- [5.5 TCP的拥塞控制 - 计算机网络微课堂 - 湖科大教书匠 - bilibili](https://www.bilibili.com/video/BV1c4411d7jb?p=61)
- [30张图解： TCP 重传、滑动窗口、流量控制、拥塞控制发愁 - 小林coding的文章 - 知乎](https://zhuanlan.zhihu.com/p/133307545)